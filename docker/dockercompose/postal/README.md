# Postal Mail Server Deployment

Postal mail server for SMTP relay on PITS (edge server with public IP).

## Architecture

```
Internet → PITS (Postal) → Tailscale → David (Stalwart)
           [Public IP]                  [User mailboxes]
```

- **Postal (PITS)**: SMTP relay with public IP, handles sending/receiving mail to/from internet
- **Stalwart (David)**: User mailboxes, IMAP/JMAP access, relays outbound mail through Postal
- **Connection**: Tailscale private network between PITS and David

## What Was Deployed

### Files Created

1. **Docker Configuration**
   - `docker/dockercompose/postal/docker-compose_postal.yml` - Docker compose definition
   - `docker/communication/postal.nix` - Generated by compose2nix (auto-generated)

2. **NixOS Module**
   - `modules/services/communication/postal.nix` - Main Postal module with:
     - Agenix secret integration
     - Automatic signing key installation
     - Config file generation with secrets
     - Database initialization (idempotent)
     - Admin user creation (automated)
     - Directory management
     - Firewall rules (ports 25, 587)

3. **Secret Management**
   - `secrets/generate-postal-secrets.sh` - Secret generation script
   - `secrets/secrets.nix` - Updated with 5 Postal secrets:
     - `postal-db-password.age`
     - `postal-rails-secret.age`
     - `postal-signing-key.age`
     - `postal-admin-email.age`
     - `postal-admin-password.age`

4. **Integration Updates**
   - `modules/services/communication/default.nix` - Added postal import
   - `profiles/edge.nix` - Enabled Postal for edge servers
   - `hosts/pits/configuration.nix` - Added Caddy reverse proxy config
   - `modules/services/communication/stalwart-mail.nix` - Added optional Postal relay

### Services Configured

- **MariaDB**: Database backend for Postal
- **Postal Runner**: Main Postal application
- **Postal Worker**: Background job processor
- **Postal SMTP**: SMTP server for mail handling
- **Caddy**: HTTPS reverse proxy for web UI at `https://postal.7andco.dev`

## Deployment Steps

### 1. Generate Secrets (REQUIRED - Run Once)

```bash
cd secrets
./generate-postal-secrets.sh
```

This will:
- Generate secure database password
- Generate Rails secret key (128 hex chars)
- Generate RSA signing key (PEM format)
- Prompt for admin email (default: admin@7andco.dev)
- Generate or prompt for admin password
- Encrypt all secrets using SSH keys from PITS host

**Save the displayed admin credentials securely!**

### 2. Commit Secrets

```bash
git add secrets/postal-*.age secrets/generate-postal-secrets.sh
git commit -m "Add Postal mail server secrets"
```

### 3. Deploy to PITS

```bash
# From your local machine
nixos-rebuild switch --flake .#pits --target-host pits
```

Or on PITS directly:
```bash
# SSH to PITS
ssh tristonyoder@pits

# Pull latest changes
cd /path/to/nix-config
git pull

# Rebuild
sudo nixos-rebuild switch --flake .#pits
```

### 4. Verify Deployment

```bash
# Check if all services are running
systemctl status podman-postal_mariadb
systemctl status podman-postal_runner
systemctl status podman-postal_worker
systemctl status podman-postal_smtp

# Check logs
journalctl -u podman-postal_runner -f
journalctl -u podman-postal_mariadb -f

# Check if database was initialized
ls /data/docker-appdata/postal/data/.db-initialized

# Check if admin user was created
ls /data/docker-appdata/postal/data/.admin-created
```

### 5. Access Web UI

Navigate to: `https://postal.7andco.dev`

Login with credentials from secret generation step (or retrieve password):
```bash
age -d -i ~/.ssh/agenix secrets/postal-admin-password.age
```

### 6. Configure Postal Organizations and Servers

1. Log into Postal web UI
2. Create an organization
3. Create a mail server
4. Configure domains and routes
5. Set up DKIM, SPF, and DMARC records in DNS

## Optional: Enable Stalwart Relay Through Postal

To configure Stalwart (on David) to relay outbound mail through Postal:

Edit `hosts/david/configuration.nix`:
```nix
modules.services.communication.stalwart-mail = {
  enable = true;
  enablePostalRelay = true;  # Enable relay through Postal
  postalRelayHost = "pits";  # Via Tailscale
  postalRelayPort = 587;
};
```

Then rebuild David:
```bash
nixos-rebuild switch --flake .#david --target-host david
```

## Ports

- **25** - SMTP (incoming mail from internet)
- **587** - SMTP Submission (outgoing mail, with auth)
- **5000** - Web UI (proxied through Caddy at https://postal.7andco.dev)

## Data Storage

All persistent data stored in: `/data/docker-appdata/postal/`
- `config/` - Configuration files (postal.yml, signing.key)
- `data/` - Application data
- `mariadb/` - Database files

## Troubleshooting

### Services Won't Start

Check service status and logs:
```bash
systemctl status podman-postal_runner
journalctl -xu podman-postal_runner
```

Check dependencies:
```bash
systemctl list-dependencies podman-postal_runner
```

### Database Not Initializing

Check initialization service:
```bash
journalctl -u postal-initialize-db
```

Reset and retry:
```bash
sudo rm /data/docker-appdata/postal/data/.db-initialized
sudo systemctl restart postal-initialize-db
```

### Admin User Creation Failed

Check creation service:
```bash
journalctl -u postal-create-admin
```

Reset and retry:
```bash
sudo rm /data/docker-appdata/postal/data/.admin-created
sudo systemctl restart postal-create-admin
```

### Can't Access Web UI

Check Caddy:
```bash
systemctl status caddy
journalctl -u caddy -f
```

Check if Postal is listening:
```bash
ss -tlnp | grep 5000
```

Test locally:
```bash
curl -I http://localhost:5000
```

### Secrets Issues

Verify secrets are properly decrypted:
```bash
ls -la /run/agenix/postal-*
```

Verify secret format:
```bash
cd secrets
./encrypt-secret.sh -v postal-db-password.age
```

## Configuration

Postal configuration is managed through:
- `modules/services/communication/postal.nix` - Main module options
- `postal.yml` - Generated at runtime from secrets
- Environment variables - Passed to containers

To modify settings, edit the module options in your host configuration.

## Security Notes

1. All secrets managed via agenix (encrypted at rest)
2. Database password auto-generated (32 bytes, base64)
3. Rails secret key auto-generated (128 hex chars)
4. RSA signing key auto-generated (1024-bit)
5. Admin password auto-generated (24 bytes, base64) or custom
6. Firewall rules restrict access to mail ports only
7. Web UI only accessible via HTTPS (Caddy with Cloudflare)

## Maintenance

### Update Postal

Update image version in `docker-compose_postal.yml`, then:
```bash
cd docker/dockercompose/postal
compose2nix -inputs=docker-compose_postal.yml -output=../../communication/postal.nix
nixos-rebuild switch --flake .#pits --target-host pits
```

### Backup

Backup these directories:
```bash
/data/docker-appdata/postal/mariadb/  # Database
/data/docker-appdata/postal/data/     # Application data
```

Secrets are already backed up in git (encrypted).

### Rotate Secrets

1. Generate new secrets: `./generate-postal-secrets.sh`
2. Commit new encrypted secrets
3. Remove initialization markers:
   ```bash
   sudo rm /data/docker-appdata/postal/data/.db-initialized
   sudo rm /data/docker-appdata/postal/data/.admin-created
   ```
4. Rebuild: `nixos-rebuild switch --flake .#pits`

## References

- [Postal Documentation](https://docs.postalserver.io/)
- [Postal GitHub](https://github.com/postalserver/postal)
- [compose2nix](https://github.com/aksiksi/compose2nix)
- [Agenix](https://github.com/ryantm/agenix)

